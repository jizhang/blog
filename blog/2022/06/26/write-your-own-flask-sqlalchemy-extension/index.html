<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Write Your Own Flask SQLAlchemy Extension | Ji ZHANG&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="When it comes to connecting to database in Flask project, we tend to use the Flask-SQLAlchemy extension that handles the lifecycle of database connection, add a certain of utilities for defining model">
<meta property="og:type" content="article">
<meta property="og:title" content="Write Your Own Flask SQLAlchemy Extension">
<meta property="og:url" content="https://shzhangji.com/blog/2022/06/26/write-your-own-flask-sqlalchemy-extension/index.html">
<meta property="og:site_name" content="Ji ZHANG&#39;s Blog">
<meta property="og:description" content="When it comes to connecting to database in Flask project, we tend to use the Flask-SQLAlchemy extension that handles the lifecycle of database connection, add a certain of utilities for defining model">
<meta property="og:locale">
<meta property="article:published_time" content="2022-06-26T04:53:16.000Z">
<meta property="article:modified_time" content="2022-06-26T04:53:16.000Z">
<meta property="article:author" content="Ji ZHANG">
<meta property="article:tag" content="python">
<meta property="article:tag" content="flask">
<meta property="article:tag" content="sqlalchemy">
<meta name="twitter:card" content="summary">
<meta name="twitter:creator" content="@zjerryj">
<link rel="publisher" href="zhangji87@gmail.com">
  
    <link rel="alternate" href="/atom.xml" title="Ji ZHANG&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="/css/source-code-pro.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  


  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-XGPVRTV36D"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-XGPVRTV36D');
  </script>
<meta name="generator" content="Hexo 6.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Ji ZHANG&#39;s Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">If I rest, I rust.</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/categories/Big-Data">Big Data</a>
        
          <a class="main-nav-link" href="/categories/Programming">Programming</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="https://shzhangji.com/cnblogs/">中文</a>
        
      </nav>
      <nav id="sub-nav">
        <a id="nav-github" class="nav-icon" target="_blank" rel="noopener" href="https://github.com/jizhang" title="GitHub"></a>
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://shzhangji.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-write-your-own-flask-sqlalchemy-extension" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2022/06/26/write-your-own-flask-sqlalchemy-extension/" class="article-date">
  <time datetime="2022-06-26T04:53:16.000Z" itemprop="datePublished">2022-06-26</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Programming/">Programming</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Write Your Own Flask SQLAlchemy Extension
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>When it comes to connecting to database in Flask project, we tend to use the <a target="_blank" rel="noopener" href="https://flask-sqlalchemy.palletsprojects.com/">Flask-SQLAlchemy</a> extension that handles the lifecycle of database connection, add a certain of utilities for defining models and executing queries, and integrate well with the Flask framework. However, if you are developing a rather simple project with Flask and SQLAlchemy, and do not want to depend on another third-party library, or you prefer using SQLAlchemy directly, making the model layer agnostic of web frameworks, you can write your own extension. Besides, you will gain better type hints for SQLAlchemy model, and possibly easier migration to SQLAlchemy 2.x. This article will show you how to integrate SQLAlchemy 1.4 with Flask 2.1.</p>
<h2 id="The-alpha-version"><a href="#The-alpha-version" class="headerlink" title="The alpha version"></a>The alpha version</h2><p>In the official document <a target="_blank" rel="noopener" href="https://flask.palletsprojects.com/en/2.1.x/extensiondev/">Flask Extension Development</a>, it shows us writing a sqlite3 extension that plays well with Flask application context. So our first try is to replace sqlite3 with SQLAlchemy:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, current_app</span><br><span class="line"><span class="keyword">from</span> flask.<span class="built_in">globals</span> <span class="keyword">import</span> _app_ctx_stack, _app_ctx_err_msg</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.engine <span class="keyword">import</span> Engine</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SQLAlchemyAlpha</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, app: <span class="type">Optional</span>[Flask] = <span class="literal">None</span></span>):</span><br><span class="line">        self.app = app</span><br><span class="line">        <span class="keyword">if</span> app <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            self.init_app(app)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">init_app</span>(<span class="params">self, app: Flask</span>):</span><br><span class="line">        app.config.setdefault(<span class="string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>, <span class="string">&#x27;sqlite://&#x27;</span>)</span><br><span class="line">        app.teardown_appcontext(self.teardown)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">connect</span>(<span class="params">self</span>) -&gt; Engine:</span><br><span class="line">        <span class="keyword">return</span> create_engine(current_app.config[<span class="string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">teardown</span>(<span class="params">self, exception</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        ctx = _app_ctx_stack.top</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(ctx, <span class="string">&#x27;sqlalchemy&#x27;</span>):</span><br><span class="line">            ctx.sqlalchemy.dispose()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">engine</span>(<span class="params">self</span>) -&gt; Engine:</span><br><span class="line">        ctx = _app_ctx_stack.top</span><br><span class="line">        <span class="keyword">if</span> ctx <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(ctx, <span class="string">&#x27;sqlalchemy&#x27;</span>):</span><br><span class="line">                ctx.sqlalchemy = self.connect()</span><br><span class="line">            <span class="keyword">return</span> ctx.sqlalchemy</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(_app_ctx_err_msg)</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<p>Several notes on our alpha version. First, it plays well with the <a target="_blank" rel="noopener" href="https://flask.palletsprojects.com/en/2.1.x/patterns/appfactories/">Application Factories</a>, that means the extension can be used to initialize multiple application instances, with different configurations for web server, testing, etc. The key point is to provide an <code>init_app</code> method for different apps, and use the <code>current_app</code> proxy during work. To initialize the app:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">app = Flask(__name__)</span><br><span class="line">db = SQLAlchemyAlpha(app)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Or</span></span><br><span class="line">db = SQLAlchemyAlpha()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_app</span>() -&gt; Flask:</span><br><span class="line">    app = Flask(__name__)</span><br><span class="line">    db.init_app(app)</span><br><span class="line">    <span class="keyword">return</span> app</span><br></pre></td></tr></table></figure>

<p>Second, it plays well with <a target="_blank" rel="noopener" href="https://flask.palletsprojects.com/en/2.1.x/appcontext/">The Application Context</a>, by storing data on current app context’s stack, instead of on the extension instance, i.e. <code>self.some_attr</code>. When the <code>engine</code> attribute is first accessed, the extension creates a SQLAlchemy engine with the current app’s config, and stores it on the current app context. When this context is popped, the engine object is also disposed, releasing the connection pool. Flask will automatically push and pop application context during request and command line interface. Here is an example of CLI:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.cli.command()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">use_alpha</span>() -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Test alpha extension.&quot;&quot;&quot;</span></span><br><span class="line">    user_count = db_alpha.engine.execute(<span class="string">&#x27;SELECT COUNT(*) FROM `user`&#x27;</span>).scalar_one()</span><br><span class="line">    app.logger.info(<span class="string">f&#x27;User count: <span class="subst">&#123;user_count&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="Keep-engine-around"><a href="#Keep-engine-around" class="headerlink" title="Keep engine around"></a>Keep engine around</h2><p>The major problem of the alpha version is constantly creating and disposing SQLAlchemy engine objects. And we known <a target="_blank" rel="noopener" href="https://docs.sqlalchemy.org/en/14/core/connections.html">Engine</a> is rather a heavy object to construct, and should be kept around throughout the lifespan of the application. There is an extension point of the Flask app instance, where we can store data for the entire app.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">init_app</span>(<span class="params">self, app: Flask</span>):</span><br><span class="line">    url = app.config[<span class="string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>]</span><br><span class="line">    app.extensions[<span class="string">&#x27;sqlalchemy&#x27;</span>] = create_engine(url)</span><br><span class="line">    app.teardown_appcontext(self.teardown)</span><br></pre></td></tr></table></figure>

<p>For working with SQLAlchemy, we often prefer using sessions, so in the extension we need to create a session for each request, and properly close it after the context is popped.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">connect</span>(<span class="params">self</span>) -&gt; Session:</span><br><span class="line">    <span class="keyword">return</span> Session(current_app.extensions[<span class="string">&#x27;sqlalchemy&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">teardown</span>(<span class="params">self, exception</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    ctx = _app_ctx_stack.top</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">hasattr</span>(ctx, <span class="string">&#x27;sqlalchemy_session&#x27;</span>):</span><br><span class="line">        ctx.sqlalchemy_session.close()</span><br><span class="line"></span><br><span class="line"><span class="meta">@property</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">session</span>(<span class="params">self</span>) -&gt; Session:</span><br><span class="line">    ctx = _app_ctx_stack.top</span><br><span class="line">    <span class="keyword">if</span> ctx <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(_app_ctx_err_msg)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(ctx, <span class="string">&#x27;sqlalchemy_session&#x27;</span>):</span><br><span class="line">        ctx.sqlalchemy_session = self.connect()</span><br><span class="line">    <span class="keyword">return</span> ctx.sqlalchemy_session</span><br></pre></td></tr></table></figure>

<p>You may wonder why we don’t use <a target="_blank" rel="noopener" href="https://docs.sqlalchemy.org/en/14/orm/contextual.html"><code>scoped_session</code></a>, which is the recommended way to use sessions in a multi-thread environment. The answer is simple: an application context will not be shared by different workers, so it is safe to use the same session throughout the request. And, since session is a light-weight object, it is OK to create it on every request. Check Werkzeug <a target="_blank" rel="noopener" href="https://werkzeug.palletsprojects.com/en/2.1.x/local/">Context Locals</a> for more information.</p>
<h2 id="Define-models-in-a-native-way"><a href="#Define-models-in-a-native-way" class="headerlink" title="Define models in a native way"></a>Define models in a native way</h2><p>Now that we have a simple but fully functional flask-sqlalchemy extension, we can start writing models in a native way.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column, Integer, String</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> declarative_base</span><br><span class="line"></span><br><span class="line">Base = declarative_base()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;user&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    username = Column(String)</span><br></pre></td></tr></table></figure>

<p>There is no <code>db.Model</code> or <code>db.Integer</code>. The model base class need to be declared explicitly, as well as the table name of each model. Add a CLI that creates the tables:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.cli.command()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init_db</span>() -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Initialize database.&quot;&quot;&quot;</span></span><br><span class="line">    Base.metadata.create_all(db.session.get_bind())</span><br></pre></td></tr></table></figure>

<p>And execute query in a view:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&#x27;/api/user/list&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_user_list</span>() -&gt; Response:</span><br><span class="line">    users: <span class="type">List</span>[User] = db.session.query(User).<span class="built_in">all</span>()</span><br><span class="line">    <span class="keyword">return</span> jsonify(users=users)</span><br></pre></td></tr></table></figure>

<p>To enable type hints for SQLAlchemy models, install <code>sqlalchemy2-stubs</code> and enable the plugin in <code>mypy.ini</code>:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mypy]</span></span><br><span class="line"><span class="attr">warn_unused_configs</span> = <span class="literal">True</span></span><br><span class="line"><span class="attr">plugins</span> = sqlalchemy.ext.mypy.plugin</span><br></pre></td></tr></table></figure>

<p>Now <code>user.id</code> will have the type <code>Column[Integer]</code>. This will continue to work in SQLAlchemy 2.x, except no extra dependency is needed. You may want to read the document <a target="_blank" rel="noopener" href="https://docs.sqlalchemy.org/en/14/orm/extensions/mypy.html">Mypy Support for ORM Mappings</a>.</p>
<p>Source code in this article can be found on <a target="_blank" rel="noopener" href="https://github.com/jizhang/blog-demo/tree/master/native-sqlalchemy">GitHub</a>.</p>
<h2 id="Appendix-I-Serialize-SQLAlchemy-models-to-JSON"><a href="#Appendix-I-Serialize-SQLAlchemy-models-to-JSON" class="headerlink" title="Appendix I: Serialize SQLAlchemy models to JSON"></a>Appendix I: Serialize SQLAlchemy models to JSON</h2><p>Flask’s built-in JSON serializer does not recoganize SQLAlchemy models, neither the frequently used <code>Decimal</code> and <code>datetime</code> objects. But we can easily enhance it with a custom encoder:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> decimal <span class="keyword">import</span> Decimal</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask.json <span class="keyword">import</span> JSONEncoder</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.engine.row <span class="keyword">import</span> Row</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm.decl_api <span class="keyword">import</span> DeclarativeMeta</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustomEncoder</span>(<span class="title class_ inherited__">JSONEncoder</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">default</span>(<span class="params">self, obj</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(obj, Decimal):</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">float</span>(obj)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(obj, datetime):</span><br><span class="line">            <span class="keyword">return</span> obj.strftime(<span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(obj, Row):</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">dict</span>(obj)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(obj.__class__, DeclarativeMeta):</span><br><span class="line">            <span class="keyword">return</span> &#123;c.name: <span class="built_in">getattr</span>(obj, c.name) <span class="keyword">for</span> c <span class="keyword">in</span> obj.__table__.columns&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>().default(obj)</span><br></pre></td></tr></table></figure>

<p><code>Row</code> is for core engine use case, and <code>DeclarativeMeta</code> for ORM. Add a line when creating the app:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.json_encoder = CustomEncoder</span><br></pre></td></tr></table></figure>

<h2 id="Appendix-II-Support-multiple-database-binds"><a href="#Appendix-II-Support-multiple-database-binds" class="headerlink" title="Appendix II: Support multiple database binds"></a>Appendix II: Support multiple database binds</h2><p>If you are interested in supporting multiple binds like Flask-SQLAlchemy does, here is a proof of concept. But for such complex scenario, I suggest use the opensource extension instead, for it is more mature, feature-complete, and fully tested.</p>
<p>This time we do not create engine on app startup. We create scoped sessions on demand.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">connect</span>(<span class="params">self, name: <span class="built_in">str</span></span>) -&gt; scoped_session:</span><br><span class="line">    <span class="keyword">if</span> name == <span class="string">&#x27;default&#x27;</span>:</span><br><span class="line">        url = current_app.config[<span class="string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        url = current_app.config[<span class="string">&#x27;SQLALCHEMY_BINDS&#x27;</span>][name]</span><br><span class="line"></span><br><span class="line">    engine = create_engine(url, echo=echo)</span><br><span class="line">    session_factory = sessionmaker(bind=engine)</span><br><span class="line">    <span class="keyword">return</span> scoped_session(session_factory)</span><br></pre></td></tr></table></figure>

<p>The configuration style mimics Flask-SQLAlchemy. This version of <code>connect</code> will return a properly configured <code>scoped_session</code> object, and it will be shared among different workers, so we store it in the app’s <code>extensions</code> dict.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Holder</span>:</span><br><span class="line">    sessions: <span class="type">Dict</span>[<span class="built_in">str</span>, scoped_session]</span><br><span class="line">    lock: Lock</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.sessions = &#123;&#125;</span><br><span class="line">        self.lock = Lock()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SQLAlchemyMulti</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">init_app</span>(<span class="params">self, app: Flask</span>):</span><br><span class="line">        app.extensions[<span class="string">&#x27;sqlalchemy_multi&#x27;</span>] = Holder()</span><br><span class="line">        app.teardown_appcontext(self.teardown)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_session</span>(<span class="params">self, name: <span class="built_in">str</span> = <span class="string">&#x27;default&#x27;</span></span>) -&gt; Session:</span><br><span class="line">        holder: Holder = current_app.extensions[<span class="string">&#x27;sqlalchemy_multi&#x27;</span>]</span><br><span class="line">        <span class="keyword">with</span> holder.lock:</span><br><span class="line">            <span class="keyword">if</span> name <span class="keyword">not</span> <span class="keyword">in</span> holder.sessions:</span><br><span class="line">                holder.sessions[name] = self.connect(name)</span><br><span class="line">            <span class="keyword">return</span> holder.sessions[name]()</span><br></pre></td></tr></table></figure>

<p>Note the creation of the <code>scoped_session</code> object is not thread-safe, so we guard it with a lock. Again, this lock should not be stored as extension instance’s attribute, we create a <code>Holder</code> class to hold both the lock and scoped sessions.</p>
<p>Do not forget to do the cleanup work:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">teardown</span>(<span class="params">self, exception</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    holder: Holder = current_app.extensions[<span class="string">&#x27;sqlalchemy_multi&#x27;</span>]</span><br><span class="line">    <span class="keyword">for</span> session <span class="keyword">in</span> holder.sessions.values():</span><br><span class="line">        session.remove()</span><br></pre></td></tr></table></figure>

<p><code>scoped_session.remove</code> will invoke <code>close</code> on the session and remove it from its registry. Next request will get a brand new session object.</p>
<p>We can verify if it uses the desired connection:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.cli.command()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">product_db</span>() -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Access product database.&quot;&quot;&quot;</span></span><br><span class="line">    db_file = db_multi.get_session(<span class="string">&#x27;product_db&#x27;</span>).execute(</span><br><span class="line">        text(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        SELECT `file` FROM pragma_database_list</span></span><br><span class="line"><span class="string">        WHERE `name` = :name</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span>),</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;main&#x27;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    ).scalar()</span><br><span class="line">    app.logger.info(<span class="string">f&#x27;Database file: <span class="subst">&#123;db_file&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure>



      
    </div>
    <footer class="article-footer">
      <a data-url="https://shzhangji.com/blog/2022/06/26/write-your-own-flask-sqlalchemy-extension/" data-id="clcogcexa002qfxowgiy5cj2v" class="article-share-link">Share</a>
      
        <a href="https://shzhangji.com/blog/2022/06/26/write-your-own-flask-sqlalchemy-extension/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/flask/" rel="tag">flask</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sqlalchemy/" rel="tag">sqlalchemy</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/blog/2022/07/01/monitor-kubernetes-volume-storage/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Monitor Kubernetes Volume Storage
        
      </div>
    </a>
  
  
    <a href="/blog/2022/06/19/openapi-workflow-with-flask-and-typescript/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">OpenAPI Workflow with Flask and TypeScript</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/algorithm/" style="font-size: 10px;">algorithm</a> <a href="/tags/analytics/" style="font-size: 14.29px;">analytics</a> <a href="/tags/apache-beam/" style="font-size: 10px;">apache beam</a> <a href="/tags/bootstrap/" style="font-size: 10px;">bootstrap</a> <a href="/tags/canal/" style="font-size: 10px;">canal</a> <a href="/tags/clojure/" style="font-size: 10px;">clojure</a> <a href="/tags/connect/" style="font-size: 10px;">connect</a> <a href="/tags/crossfilter/" style="font-size: 10px;">crossfilter</a> <a href="/tags/dc-js/" style="font-size: 10px;">dc.js</a> <a href="/tags/devops/" style="font-size: 10px;">devops</a> <a href="/tags/eclipse/" style="font-size: 10px;">eclipse</a> <a href="/tags/elasticsearch/" style="font-size: 10px;">elasticsearch</a> <a href="/tags/es6/" style="font-size: 10px;">es6</a> <a href="/tags/eslint/" style="font-size: 11.43px;">eslint</a> <a href="/tags/etl/" style="font-size: 12.86px;">etl</a> <a href="/tags/flask/" style="font-size: 12.86px;">flask</a> <a href="/tags/flink/" style="font-size: 11.43px;">flink</a> <a href="/tags/flume/" style="font-size: 12.86px;">flume</a> <a href="/tags/frontend/" style="font-size: 17.14px;">frontend</a> <a href="/tags/functional-programming/" style="font-size: 10px;">functional programming</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/github/" style="font-size: 10px;">github</a> <a href="/tags/hadoop/" style="font-size: 10px;">hadoop</a> <a href="/tags/hbase/" style="font-size: 10px;">hbase</a> <a href="/tags/hdfs/" style="font-size: 11.43px;">hdfs</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/hive/" style="font-size: 11.43px;">hive</a> <a href="/tags/java/" style="font-size: 18.57px;">java</a> <a href="/tags/javascript/" style="font-size: 15.71px;">javascript</a> <a href="/tags/kafka/" style="font-size: 11.43px;">kafka</a> <a href="/tags/kubernetes/" style="font-size: 11.43px;">kubernetes</a> <a href="/tags/lodash/" style="font-size: 11.43px;">lodash</a> <a href="/tags/machine-learning/" style="font-size: 10px;">machine learning</a> <a href="/tags/mapreduce/" style="font-size: 10px;">mapreduce</a> <a href="/tags/mysql/" style="font-size: 10px;">mysql</a> <a href="/tags/openapi/" style="font-size: 10px;">openapi</a> <a href="/tags/ops/" style="font-size: 10px;">ops</a> <a href="/tags/pandas/" style="font-size: 11.43px;">pandas</a> <a href="/tags/parcel/" style="font-size: 10px;">parcel</a> <a href="/tags/pinia/" style="font-size: 10px;">pinia</a> <a href="/tags/prometheus/" style="font-size: 10px;">prometheus</a> <a href="/tags/python/" style="font-size: 20px;">python</a> <a href="/tags/react/" style="font-size: 10px;">react</a> <a href="/tags/restful/" style="font-size: 10px;">restful</a> <a href="/tags/scala/" style="font-size: 11.43px;">scala</a> <a href="/tags/scalatra/" style="font-size: 10px;">scalatra</a> <a href="/tags/source-code/" style="font-size: 10px;">source code</a> <a href="/tags/spark/" style="font-size: 14.29px;">spark</a> <a href="/tags/spark-streaming/" style="font-size: 10px;">spark streaming</a> <a href="/tags/spring/" style="font-size: 12.86px;">spring</a> <a href="/tags/spring-boot/" style="font-size: 10px;">spring boot</a> <a href="/tags/sql/" style="font-size: 11.43px;">sql</a> <a href="/tags/sqlalchemy/" style="font-size: 11.43px;">sqlalchemy</a> <a href="/tags/stream-processing/" style="font-size: 12.86px;">stream processing</a> <a href="/tags/tensorflow/" style="font-size: 10px;">tensorflow</a> <a href="/tags/thrift/" style="font-size: 10px;">thrift</a> <a href="/tags/typescript/" style="font-size: 12.86px;">typescript</a> <a href="/tags/vite/" style="font-size: 10px;">vite</a> <a href="/tags/vue/" style="font-size: 15.71px;">vue</a> <a href="/tags/vuex/" style="font-size: 10px;">vuex</a> <a href="/tags/webjars/" style="font-size: 10px;">webjars</a> <a href="/tags/webpack/" style="font-size: 10px;">webpack</a> <a href="/tags/websocket/" style="font-size: 10px;">websocket</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">January 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">July 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">June 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">May 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">April 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/05/">May 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/10/">October 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/04/">April 2013</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/blog/2023/01/09/mock-api-in-parcel-project/">Mock API in Parcel Project</a>
          </li>
        
          <li>
            <a href="/blog/2022/08/31/configure-git-line-endings-across-oses/">Configure Git Line Endings Across OSes</a>
          </li>
        
          <li>
            <a href="/blog/2022/08/10/configure-logging-for-flask-sqlalchemy-project/">Configure Logging for Flask SQLAlchemy Project</a>
          </li>
        
          <li>
            <a href="/blog/2022/07/31/use-composition-api-and-pinia-in-vue-2-project/">Use Composition API and Pinia in Vue 2 Project</a>
          </li>
        
          <li>
            <a href="/blog/2022/07/24/add-typescript-support-to-vue-2-project/">Add TypeScript Support to Vue 2 Project</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      <a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://mirrors.creativecommons.org/presskit/buttons/80x15/svg/by-nc-sa.svg"></a>
      <br>
      &copy; 2023 Ji ZHANG<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/categories/Big-Data" class="mobile-nav-link">Big Data</a>
  
    <a href="/categories/Programming" class="mobile-nav-link">Programming</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="https://shzhangji.com/cnblogs/" class="mobile-nav-link">中文</a>
  
</nav>

    
<script>
  var disqus_shortname = 'jizhang';
  
  var disqus_url = 'https://shzhangji.com/blog/2022/06/26/write-your-own-flask-sqlalchemy-extension/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>



<script src="/js/jquery.min.js"></script>



  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>


  </div>
</body>
</html>